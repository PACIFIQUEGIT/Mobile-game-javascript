<!DOCTYPE html>
<html>
<head>
  <title>JavaScript Programming | ZENVA.com</title>
  <meta name="viewport" content="width=device-width, user-scalable=no" />
  <style>
    canvas {
      border: 1px solid black;
      width: 100%;
    }
  </style>
</head>
<body>
  <h1>Challenge - Multi-Level Game SOLUTION</h1>
  <canvas id="mycanvas" width="640" height="360"></canvas>

  <script>
    window.addEventListener("load", function () {

      //constants
      var GAME_WIDTH = 640;
      var GAME_HEIGHT = 360;

      var gameLive = true;
      var level = 1;

      var enemies = [
        { x: 100, y: 100, speedY: 2, w: 40, h: 40 },
        { x: 200, y: 0, speedY: 2, w: 40, h: 40 },
        { x: 330, y: 100, speedY: 3, w: 40, h: 40 },
        { x: 450, y: 100, speedY: -3, w: 40, h: 40 }
      ];

      var player = {
        x: 10,
        y: 160,
        speedX: 2.5,
        isMoving: false,
        w: 40,
        h: 40
      };

      var goal = {
        x: 580,
        y: 160,
        w: 50,
        h: 36
      };

      var sprites = {};

      var movePlayer = function () {
        player.isMoving = true;
      };

      var stopPlayer = function () {
        player.isMoving = false;
      };

      var canvas = document.getElementById("mycanvas");
      var ctx = canvas.getContext("2d");

      canvas.addEventListener('mousedown', movePlayer);
      canvas.addEventListener('mouseup', stopPlayer);
      canvas.addEventListener('touchstart', movePlayer);
      canvas.addEventListener('touchend', stopPlayer);

      // ✅ LOAD IMAGES WITH CALLBACK
      var load = function (callback) {
        var toLoad = 4;
        var loaded = 0;

        function onLoad() {
          loaded++;
          if (loaded === toLoad) {
            callback();
          }
        }

        sprites.player = new Image();
        sprites.player.onload = onLoad;
        sprites.player.onerror = () => console.error("Failed to load player image");
        sprites.player.src = 'images/hero.png';

        sprites.background = new Image();
        sprites.background.onload = onLoad;
        sprites.background.onerror = () => console.error("Failed to load background image");
        sprites.background.src = 'images/floor.png';

        sprites.enemy = new Image();
        sprites.enemy.onload = onLoad;
        sprites.enemy.onerror = () => console.error("Failed to load enemy image");
        sprites.enemy.src = 'images/enemy.png';

        sprites.goal = new Image();
        sprites.goal.onload = onLoad;
        sprites.goal.onerror = () => console.error("Failed to load goal image");
        sprites.goal.src = 'images/chest.png';
      };

      var update = function () {
        if (checkCollision(player, goal)) {
          level++;

          player.x = 10;
          player.y = 160;

          enemies.forEach(function (element) {
            element.speedY += element.speedY / Math.abs(element.speedY);
          });

          console.log("Level: " + level);
        }

        if (player.isMoving) {
          player.x = player.x + player.speedX;
        }

        enemies.forEach(function (element) {
          if (checkCollision(player, element)) {
            gameLive = false;
            alert('Game Over!');
            window.location = "";
          }

          element.y += element.speedY;

          if (element.y <= 10) {
            element.y = 10;
            element.speedY *= -1;
          } else if (element.y >= GAME_HEIGHT - 50) {
            element.y = GAME_HEIGHT - 50;
            element.speedY *= -1;
          }
        });
      };

      var draw = function () {
        ctx.clearRect(0, 0, GAME_WIDTH, GAME_HEIGHT);

        ctx.drawImage(sprites.background, 0, 0);
        ctx.drawImage(sprites.player, player.x, player.y);

        enemies.forEach(function (element) {
          ctx.drawImage(sprites.enemy, element.x, element.y);
        });

        ctx.drawImage(sprites.goal, goal.x, goal.y);
      };

      var step = function () {
        update();
        draw();

        if (gameLive) {
          window.requestAnimationFrame(step);
        }
      };

      var checkCollision = function (rect1, rect2) {
        var closeOnWidth = Math.abs(rect1.x - rect2.x) <= Math.max(rect1.w, rect2.w);
        var closeOnHeight = Math.abs(rect1.y - rect2.y) <= Math.max(rect1.h, rect2.h);
        return closeOnWidth && closeOnHeight;
      };

      // ✅ Start the game only when all images are loaded
      load(function () {
        step();
      });

    });
  </script>
</body>
</html>
